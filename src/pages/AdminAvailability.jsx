// ==========================================================\n// FILE: AdminAvailability.jsx\n// Admin page to manage blocked dates/times\n// Now reads/writes to Supabase via get-blocked-slots function\n// Location: src/pages/AdminAvailability.jsx\n// ==========================================================\n\nimport React, { useState, useEffect } from "react";\nimport { FHJCard, FHJButton, FHJInput, fhjTheme } from "../components/FHJ/FHJUIKit.jsx";\n\nexport default function AdminAvailability() {\n  const [slots, setSlots] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n\n  // Form state\n  const [blockDate, setBlockDate] = useState("");\n  const [blockAllDay, setBlockAllDay] = useState(true);\n  const [blockTimes, setBlockTimes] = useState([]);\n  const [blockReason, setBlockReason] = useState("");\n  const [showForm, setShowForm] = useState(false);\n  const [error, setError] = useState("");\n\n  // Holidays (from get-blocked-slots)\n  const [holidays, setHolidays] = useState([]);\n\n  useEffect(() => { loadSlots(); }, []);\n\n  // âœ… LOAD â€” reads from Supabase via get-blocked-slots\n  const loadSlots = async () => {\n    setLoading(true);\n    try {\n      const res = await fetch("/.netlify/functions/get-blocked-slots");\n      const data = await res.json();\n\n      // Flatten blockedDates + blockedTimes into a single slots array for the UI\n      const allSlots = [];\n      (data.blockedDates || []).forEach((b) => {\n        allSlots.push({ id: b.id, date: b.date, block_type: "all_day", reason: b.reason, allDay: true });\n      });\n      Object.entries(data.blockedTimes || {}).forEach(([date, times]) => {\n        times.forEach((t) => {\n          allSlots.push({ id: t.id, date, block_type: "time", time: t.time, reason: t.reason, allDay: false });\n        });\n      });\n      setSlots(allSlots);\n      setHolidays(data.holidays || []);\n    } catch (err) {\n      console.error("Failed to load blocked slots:", err);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // âœ… ADD â€” posts to Supabase; one row per time slot\n  const handleAdd = async () => {\n    if (!blockDate) return;\n    setSaving(true);\n    setError("");\n    try {\n      if (blockAllDay || blockTimes.length === 0) {\n        // Single all-day block\n        const res = await fetch("/.netlify/functions/get-blocked-slots", {\n          method: "POST",\n          headers: { "Content-Type": "application/json" },\n          body: JSON.stringify({ date: blockDate, reason: blockReason || "Blocked by admin", block_type: "all_day" }),\n        });\n        const data = await res.json();\n        if (!res.ok || !data.success) throw new Error(data.error || "Save failed");\n      } else {\n        // One insert per selected time slot\n        for (const time of blockTimes) {\n          const res = await fetch("/.netlify/functions/get-blocked-slots", {\n            method: "POST",\n            headers: { "Content-Type": "application/json" },\n            body: JSON.stringify({ date: blockDate, time, reason: blockReason || "Blocked by admin", block_type: "time" }),\n          });\n          const data = await res.json();\n          if (!res.ok || !data.success) throw new Error(data.error || "Save failed");\n        }\n      }\n      setBlockDate(""); setBlockTimes([]); setBlockReason(""); setShowForm(false); setError("");\n      await loadSlots();\n    } catch (err) {\n      setError(err.message);\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  // âœ… DELETE â€” deletes from Supabase by id query param\n  const handleDelete = async (id) => {\n    if (!confirm("Remove this blocked slot?")) return;\n    try {\n      await fetch(`/.netlify/functions/get-blocked-slots?id=${id}`, { method: "DELETE" });\n      await loadSlots();\n    } catch (err) {\n      console.error("Failed to delete:", err);\n    }\n  };\n\n  const toggleTime = (slot) => {\n    setBlockTimes((prev) =>\n      prev.includes(slot) ? prev.filter((t) => t !== slot) : [...prev, slot]\n    );\n  };\n\n  const TIME_OPTIONS = [];\n  for (let h = 6; h <= 22; h++) {\n    for (let m = 0; m < 60; m += 30) {\n      const hr = h === 0 ? 12 : h > 12 ? h - 12 : h;\n      const ampm = h < 12 ? "AM" : "PM";\n      TIME_OPTIONS.push(`${hr}:${m === 0 ? "00" : "30"} ${ampm}`);\n    }\n  }\n  TIME_OPTIONS.push("11:00 PM");\n\n  const formatDate = (d) => {\n    if (!d) return "";\n    try {\n      return new Date(d + "T12:00:00").toLocaleDateString("en-US", {\n        weekday: "short", month: "short", day: "numeric", year: "numeric",\n      });\n    } catch { return d; }\n  };\n\n  // Upcoming holidays\n  const today = new Date().toISOString().split("T")[0];\n  const upcomingHolidays = holidays.filter((h) => (h.date || h) >= today).slice(0, 8);\n\n  return (\n    <div style={{ padding: "2rem", maxWidth: "900px", margin: "0 auto" }}>\n      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "2rem" }}>\n        <div>\n          <h1 style={{ color: "white", fontSize: "1.6rem", fontWeight: 400, margin: 0 }}>Availability Manager</h1>\n          <p style={{ color: "#64748b", fontSize: "0.85rem", marginTop: "0.4rem" }}>\n            Block dates and times so clients can't book them.\n          </p>\n        </div>\n        <FHJButton onClick={() => setShowForm(!showForm)} style={{ padding: "0.6rem 1.5rem" }}>\n          {showForm ? "Cancel" : "+ Block Date/Time"}\n        </FHJButton>\n      </div>\n\n      {/* ADD FORM */} \n      {showForm && (\n        <FHJCard style={{ padding: "1.5rem", marginBottom: "2rem" }}>\n          <h3 style={{ color: "white", fontSize: "1rem", fontWeight: 500, marginTop: 0, marginBottom: "1.25rem" }}>\n            Block a Date or Time Slots\n          </h3>\n\n          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: "1rem", marginBottom: "1rem" }}>\n            <div>\n              <label style={labelSt}>Date *</label>\n              <input\n                type="date"\n                value={blockDate}\n                onChange={(e) => setBlockDate(e.target.value)}\n                style={inputSt}\n              />\n            </div>\n            <div>\n              <label style={labelSt}>Reason</label>\n              <input\n                type="text"\n                value={blockReason}\n                onChange={(e) => setBlockReason(e.target.value)}\n                placeholder="e.g., Staff meeting, Vacation..."\n                style={inputSt}\n              />\n            </div>\n          </div>\n\n          {/* All Day toggle */}\n          <div style={{ marginBottom: "1rem" }}>\n            <label\n              onClick={() => setBlockAllDay(!blockAllDay)}\n              style={{ display: "flex", alignItems: "center", gap: "0.6rem", cursor: "pointer" }}\n            >\n              <div style={{\n                width: "40px", height: "22px", borderRadius: "11px",\n                background: blockAllDay ? fhjTheme.primary : "rgba(255,255,255,0.15)",\n                position: "relative", transition: "background 0.2s",\n              }}>\n                <div style={{\n                  width: "18px", height: "18px", borderRadius: "50%", background: "white",\n                  position: "absolute", top: "2px",\n                  left: blockAllDay ? "20px" : "2px", transition: "left 0.2s",\n                }} />\n              </div>\n              <span style={{ color: "rgba(255,255,255,0.8)", fontSize: "0.85rem" }}>Block entire day</span>\n            </label>\n          </div>\n\n          {/* Time picker (if not all day) */}\n          {!blockAllDay && (\n            <div style={{ marginBottom: "1rem" }}>\n              <label style={labelSt}>Select times to block</label>\n              <div style={{ display: "grid", gridTemplateColumns: "repeat(6, 1fr)", gap: "0.3rem", maxHeight: "200px", overflowY: "auto" }}>\n                {TIME_OPTIONS.map((slot) => (\n                  <button\n                    key={slot}\n                    onClick={() => toggleTime(slot)}\n                    style={{\n                      padding: "0.4rem 0.2rem", borderRadius: "6px", fontSize: "0.72rem",\n                      border: "1px solid",\n                      cursor: "pointer", transition: "all 0.15s",\n                      background: blockTimes.includes(slot) ? "rgba(248,113,113,0.2)" : "rgba(255,255,255,0.04)",\n                      borderColor: blockTimes.includes(slot) ? "#f87171" : "rgba(255,255,255,0.1)",\n                      color: blockTimes.includes(slot) ? "#f87171" : "rgba(255,255,255,0.6)",\n                    }}\n                  >\n                    {slot}\n                  </button>\n                ))} \n              </div>\n              {blockTimes.length > 0 && (\n                <p style={{ color: "#f87171", fontSize: "0.75rem", marginTop: "0.5rem" }}>\n                  {blockTimes.length} time slot{blockTimes.length > 1 ? "s" : ""} selected\n                </p>\n              )} \n            </div>\n          )} \n\n          {error && (\n            <p style={{ color: "#f87171", fontSize: "0.85rem", padding: "0.5rem 0.75rem", background: "rgba(248,113,113,0.1)", borderRadius: "6px", border: "1px solid rgba(248,113,113,0.3)" }}>\n              {error}\n            </p>\n          )} \n\n          <div style={{ display: "flex", gap: "0.75rem" }}>\n            <FHJButton onClick={handleAdd} disabled={!blockDate || saving} style={{ padding: "0.6rem 2rem" }}>\n              {saving ? "Saving..." : "Block This Date"}\n            </FHJButton>\n            <FHJButton variant="ghost" onClick={() => setShowForm(false)} style={{ padding: "0.6rem 1.5rem" }}>\n              Cancel\n            </FHJButton>\n          </div>\n        </FHJCard>\n      )} \n\n      {/* BLOCKED SLOTS LIST */} \n      <FHJCard style={{ padding: "1.5rem", marginBottom: "2rem" }}>\n        <h3 style={{ color: "white", fontSize: "1rem", fontWeight: 500, marginTop: 0, marginBottom: "1rem" }}>\n          Custom Blocked Dates\n        </h3>\n\n        {loading ? (\n          <p style={{ color: "#64748b", fontSize: "0.85rem" }}>Loading...</p>\n        ) : slots.length === 0 ? (\n          <div style={{ textAlign: "center", padding: "2rem", color: "#64748b" }}>\n            <p style={{ fontSize: "2rem", marginBottom: "0.5rem" }}>ðŸ“…</p>\n            <p style={{ fontSize: "0.9rem" }}>No custom blocked dates yet.</p>\n            <p style={{ fontSize: "0.8rem" }}>Click "Block Date/Time" to add unavailable dates.</p>\n          </div>\n        ) : (\n          <div style={{ display: "flex", flexDirection: "column", gap: "0.5rem" }}>\n            {slots.map((slot) => {\n              const date = slot.date || "";\n              const time = slot.time || "";\n              const allDay = slot.allDay || slot.block_type === "all_day";\n              const reason = slot.reason || "";\n\n              return (\n                <div\n                  key={slot.id}\n                  style={{\n                    display: "flex", justifyContent: "space-between", alignItems: "center",\n                    padding: "0.75rem 1rem", borderRadius: "10px",\n                    background: "rgba(248,113,113,0.06)",\n                    border: "1px solid rgba(248,113,113,0.15)",\n                  }}\n                >\n                  <div style={{ flex: 1 }}>\n                    <div style={{ display: "flex", alignItems: "center", gap: "0.75rem" }}>\n                      <span style={{ color: "white", fontWeight: 500, fontSize: "0.9rem" }}>\n                        {formatDate(date)}\n                      </span>\n                      {allDay ? (\n                        <span style={badgeSt("#f87171")}>All Day</span>\n                      ) : time ? (\n                        <span style={badgeSt("#f59e0b")}>{time}</span>\n                      ) : null}\n                    </div>\n                    {reason && <p style={{ color: "#94a3b8", fontSize: "0.78rem", margin: "0.25rem 0 0" }}>{reason}</p>}\n                  </div>\n                  <button\n                    onClick={() => handleDelete(slot.id)}\n                    style={{\n                      background: "none", border: "none", color: "#64748b", cursor: "pointer",\n                      padding: "0.4rem", fontSize: "1.1rem", transition: "color 0.2s",\n                    }}\n                    onMouseOver={(e) => (e.target.style.color = "#f87171")}\n                    onMouseOut={(e) => (e.target.style.color = "#64748b")}\n                    title="Remove block"\n                  >\n                    âœ•\n                  </button>\n                </div>\n              );\n            })} \n          </div>\n        )} \n      </FHJCard>\n\n      {/* HOLIDAYS */} \n      <FHJCard style={{ padding: "1.5rem" }}>\n        <h3 style={{ color: "white", fontSize: "1rem", fontWeight: 500, marginTop: 0, marginBottom: "0.5rem" }}>\n          Upcoming Holidays (Auto-Blocked)\n        </h3>\n        <p style={{ color: "#64748b", fontSize: "0.78rem", marginBottom: "1rem" }}>\n          These are automatically blocked. Contact support to customize the holiday list.\n        </p>\n        <div style={{ display: "grid", gridTemplateColumns: "repeat(2, 1fr)", gap: "0.4rem" }}>\n          {upcomingHolidays.map((h, i) => (\n            <div key={i} style={{\n              padding: "0.5rem 0.75rem", borderRadius: "8px",\n              background: "rgba(255,255,255,0.03)", border: "1px solid rgba(255,255,255,0.06)",\n              display: "flex", alignItems: "center", gap: "0.5rem",\n            }}>\n              <span style={{ color: "#f87171", fontSize: "0.8rem" }}>ðŸ”´</span>\n              <span style={{ color: "rgba(255,255,255,0.7)", fontSize: "0.82rem" }}>{formatDate(h.date || h)} {h.name ? `â€” ${h.name}` : ""}</span>\n            </div>\n          ))} \n        </div>\n      </FHJCard>\n    </div>\n  );\n}\n\nconst labelSt = { color: "rgba(255,255,255,0.7)", fontSize: "0.75rem", marginBottom: "0.35rem", fontWeight: 500, textTransform: "uppercase", letterSpacing: "0.5px", display: "block" };\nconst inputSt = { width: "100%", padding: "0.6rem 0.75rem", borderRadius: "8px", background: "rgba(255,255,255,0.06)", border: "1px solid rgba(255,255,255,0.12)", color: "white", fontSize: "0.9rem", outline: "none" };\nconst badgeSt = (color) => ({\n  display: "inline-block", padding: "0.15rem 0.5rem", borderRadius: "999px",\n  fontSize: "0.68rem", fontWeight: 600, letterSpacing: "0.3px",\n  background: `${color}15`, color, border: `1px solid ${color}30`,\n});